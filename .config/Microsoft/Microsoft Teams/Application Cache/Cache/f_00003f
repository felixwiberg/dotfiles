webpackJsonp([53],{2505:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),n(2506)},2506:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),o=this&&this.__assign||function(){return(o=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++){t=arguments[n];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0});var s="MonetizationService",a=function(e){function t(t,n,i,o,a,r,c,p,l,u){var g=e.call(this,r)||this;g.$rootScope=t,g.authenticationService=n,g.constants=i,g.loggingService=a,g.orchestrationService=r,g.settingsService=c,g.utilityService=p,g.monetizationDatabase=l,g.$q=u,g.logger=a.newLogger(s);var h=new teamspace.services.DataManagerOptions(i.urls.monetizationService.products.type,function(e){return"products"});h.useTeamspaceTokens=!1,h.isTransient=!0,g.productListDataManager=o.registerManager(h);var v=new teamspace.services.DataManagerOptions(i.urls.monetizationService.assets.type,function(e){return"assets"});v.useTeamspaceTokens=!1,v.isTransient=!0,g.assetListDataManager=o.registerManager(v);var m=new teamspace.services.DataManagerOptions(i.urls.monetizationService.saasState.type,function(e){return e.setupUrlWithToken});m.useTeamspaceTokens=!1,m.isTransient=!0,g.saasStateDataManager=o.registerManager(m);var d=new teamspace.services.DataManagerOptions(i.urls.monetizationService.billingRegion.type,function(e){return"billingRegion"});d.useTeamspaceTokens=!1,d.isTransient=!0,g.billingRegionDataManager=o.registerManager(d);var f=new teamspace.services.DataManagerOptions(i.urls.monetizationService.supportedBillingRegions.type,function(e){return"countries"});return f.useTeamspaceTokens=!1,f.isTransient=!0,g.supportedBillingRegionsDataManager=o.registerManager(f),g.initializeOnAppLaunchAndReinit("launch"),g}return i(t,e),t.$inject=["$rootScope","authenticationService","constants","dataManagerService","loggingService","orchestrationService","settingsService","utilityService","monetizationDatabase","$q"],t.prototype.initializeOnAppLaunchAndReinit=function(e){this.logger.info("initializeOnAppLaunchAndReinit monetizationService: reason = {0}",e)},t.prototype.cleanupOnAppTeardown=function(e){this.logger.info("cleanupOnAppTeardown monetizationService: reason = {0}",e)},t.prototype.mtmaTelemetryIdentifier=function(){return s},t.prototype.getSupportedBillingRegions=function(){var e=this,t=this.loggingService.newScenario(this.constants.scenarios.extensibility.monetization.apis.supportBillingRegions);if(!this.settingsService.valueAsBoolean(this.constants.settings.names.enableMonetization))return t.fail({error2:"monetization feature flag is not enabled"}),Promise.resolve(null);var n=this.settingsService.valueFor(this.constants.settings.names.monetizationConstants);return this.getSupportedBillingRegionsCache(n).then(function(i){return i?(t.appendEventData(o(o({},e.getSupportedBillingRegionsEventData(i)),{source:e.constants.scenarios.extensibility.monetization.cache.supportedBillingRegions})),t.stop(),i):e.getSupportedBillingRegionsFromApi(n).then(function(n){if(!n)throw"empty response from Billing Regions API";return t.appendEventData(o(o({},e.getSupportedBillingRegionsEventData(n)),{source:e.constants.scenarios.extensibility.monetization.apis.supportBillingRegions})),t.stop(),n})}).catch(function(e){var n=JSON.stringify(teamspace.services.AppsServiceUtils.getSafeError(e));return t.fail({error:n,error2:n}),Promise.resolve(null)})},t.prototype.getBillingRegion=function(){var e=this,t=this.loggingService.newScenario(this.constants.scenarios.extensibility.monetization.apis.billingRegion);if(!this.settingsService.valueAsBoolean(this.constants.settings.names.enableMonetization))return t.fail({error2:"monetization feature flag is not enabled"}),Promise.resolve(null);var n=this.settingsService.valueFor(this.constants.settings.names.monetizationConstants);return this.getBillingRegionCache().then(function(i){return i?(t.appendEventData(o(o({},e.getBillingRegionEventData(i)),{source:e.constants.scenarios.extensibility.monetization.cache.billingRegion})),t.stop(),i):e.getBillingRegionFromApi(n).then(function(n){return t.appendEventData(o(o({},e.getBillingRegionEventData(n)),{source:e.constants.scenarios.extensibility.monetization.apis.billingRegion})),t.stop(),n})})},t.prototype.setBillingRegion=function(e){var t=this.loggingService.newScenario(this.constants.scenarios.extensibility.monetization.apis.billingRegion);return this.settingsService.valueAsBoolean(this.constants.settings.names.enableMonetization)?(this.putBillingRegionCache(e),t.stop(),this.refreshMonetizationCache()):(t.fail({error2:"monetization feature flag is not enabled"}),Promise.resolve(null))},t.prototype.getProducts=function(){var e=this,t=this.loggingService.newScenario(this.constants.scenarios.extensibility.monetization.cache.products);if(!this.settingsService.valueAsBoolean(this.constants.settings.names.enableMonetization))return t.fail({error2:"monetization feature flag is not enabled"}),Promise.resolve(null);var n=this.settingsService.valueFor(this.constants.settings.names.monetizationConstants);return this.getMonetizationAppsListCache(n).then(function(i){return i?(t.appendEventData(o(o({},e.getMonetizationAppsListEventData(i)),{source:e.constants.scenarios.extensibility.monetization.cache.products})),t.stop(),i):e.getProductsFromAPI(n).then(function(n){if(!n)throw"empty response from Products API";return t.appendEventData(o(o({},e.getMonetizationAppsListEventData(n)),{source:e.constants.scenarios.extensibility.monetization.apis.products})),t.stop(),n})}).catch(function(e){var n=JSON.stringify(teamspace.services.AppsServiceUtils.getSafeError(e));return t.fail({error:n,error2:n}),Promise.resolve(null)})},t.prototype.getAssets=function(){var e=this,t=this.loggingService.newScenario(this.constants.scenarios.extensibility.monetization.cache.assets);if(!this.settingsService.valueAsBoolean(this.constants.settings.names.enableMonetization))return t.fail({error2:"monetization feature flag is not enabled"}),Promise.resolve(null);var n=this.settingsService.valueFor(this.constants.settings.names.monetizationConstants);return this.getAssetsListCache(n).then(function(i){return i?(t.appendEventData(o(o({},e.getAssetsListEventData(i)),{source:e.constants.scenarios.extensibility.monetization.cache.assets})),t.stop(),i):e.getAssetsFromAPI(n).then(function(n){if(!n)throw"empty response from Assets API";return t.appendEventData(o(o({},e.getAssetsListEventData(n)),{source:e.constants.scenarios.extensibility.monetization.apis.assets})),t.stop(),n})}).catch(function(e){var n=JSON.stringify(teamspace.services.AppsServiceUtils.getSafeError(e));return t.fail({error:n,error2:n}),Promise.resolve(null)})},t.prototype.getProductAndAssetDetails=function(e){var t=this,n=this.loggingService.newScenario(this.constants.scenarios.extensibility.monetization.cache.productAndAssetDetails);return this.settingsService.valueAsBoolean(this.constants.settings.names.enableMonetization)?this.getProducts().then(function(i){if(!i||0==i.length)return n.stop(),null;var o=i.find(function(t){return t&&t.associatedSaaSProducts&&t.associatedSaaSProducts.length>0&&t.officeProductId==e});return o?t.getAssets().then(function(e){var t=o.associatedSaaSProducts[0].saasBigCatalogId,i={officeProductName:o.officeProductName,officeProductId:o.officeProductId,associatedSaaSProducts:o.associatedSaaSProducts,activeSubscription:null};if(e&&e.length>0)for(var s=0;s<o.associatedSaaSProducts.length;s++){var a=o.associatedSaaSProducts[s];t=a.saasBigCatalogId;var r=e.find(function(e){return e&&e.isActive&&e.saasBigCatalogId==t});if(r)return i.activeSubscription=r,n.stop(),i}return n.stop(),i}):(n.stop(),null)}):(n.fail({error2:"monetization feature flag is not enabled"}),Promise.resolve(null))},t.prototype.getSaaSState=function(e){var t=this,n=this.loggingService.newScenario(this.constants.scenarios.extensibility.monetization.apis.saaSState);if(!this.settingsService.valueAsBoolean(this.constants.settings.names.enableMonetization))return n.fail({error2:"monetization feature flag is not enabled"}),Promise.resolve(null);var i=this.settingsService.valueFor(this.constants.settings.names.monetizationConstants);return this.generateDataManagerRequestOptions(i,n).then(function(n){var o={url:""+t.utilityService.combineUriComponents(i.endpointUri,i.assetSaaSStatePath,e),method:"GET",timeout:i.productsHttpTimeoutSeconds*t.constants.timeInMiliseconds.second,skipCommonHeaders:!0};return t.saasStateDataManager.invoke(o,n)}).then(function(e){if(!e)throw"empty response from SaaSState API";return n.appendEventData({configUrl:e.setupUrlWithToken}),n.stop(),e}).catch(function(e){var t=JSON.stringify(teamspace.services.AppsServiceUtils.getSafeError(e));return n.fail({error:t,error2:t}),Promise.resolve(null)})},t.prototype.refreshMonetizationCache=function(){var e=this,t=this.loggingService.newScenario(this.constants.scenarios.extensibility.monetization.cache.refreshCache);if(!this.settingsService.valueAsBoolean(this.constants.settings.names.enableMonetization))return t.fail({error2:"monetization feature flag is not enabled"}),Promise.resolve(null);var n=this.settingsService.valueFor(this.constants.settings.names.monetizationConstants);return this.getProductsFromAPI(n).then(function(i){if(!i)throw"empty response from Products API";return e.getAssetsFromAPI(n).then(function(s){if(!s)throw"empty response from Assets API";return e.getSupportedBillingRegionsFromApi(n).then(function(n){if(!n)throw"empty response from Billing Regions API";var a={products:i,assets:s,countries:n};return t.appendEventData(o(o({},a),{source:e.constants.scenarios.extensibility.monetization.cache.refreshCache})),t.stop(),a})})})},t.prototype.getBillingRegionFromApi=function(e){var t=this,n=this.loggingService.newScenario(this.constants.scenarios.extensibility.monetization.apis.billingRegion);return this.generateDataManagerRequestOptions(e,n).then(function(n){var i={url:""+t.utilityService.combineUriComponents(e.endpointUri,e.billingRegionPath),method:"GET",timeout:1e3*e.productsHttpTimeoutSeconds,skipCommonHeaders:!0};return t.billingRegionDataManager.invoke(i,n)}).then(function(e){if(e){var i=JSON.stringify(e);n.appendEventData({responseData:i})}return n.stop(),t.putBillingRegionCache(e),e}).catch(function(e){var t=JSON.stringify(teamspace.services.AppsServiceUtils.getSafeError(e));return n.fail({error:t,error2:t}),null})},t.prototype.getSupportedBillingRegionsFromApi=function(e){var t=this,n=this.loggingService.newScenario(this.constants.scenarios.extensibility.monetization.apis.supportBillingRegions);return this.generateDataManagerRequestOptions(e,n).then(function(n){var i={url:""+t.utilityService.combineUriComponents(e.endpointUri,e.supportBillingRegionsPath),method:"GET",timeout:1e3*e.productsHttpTimeoutSeconds,skipCommonHeaders:!0};return t.supportedBillingRegionsDataManager.invoke(i,n)}).then(function(e){if(!e)throw"empty response from GetSupportedBillingRegions";var i=JSON.stringify(e);return n.appendEventData({responseData:i}),n.stop(),t.putSupportedBillingRegionsCache(e),e}).catch(function(e){var t=JSON.stringify(teamspace.services.AppsServiceUtils.getSafeError(e));return n.fail({error:t,error2:t}),null})},t.prototype.getProductsFromAPI=function(e){var t=this,n=this.loggingService.newScenario(this.constants.scenarios.extensibility.monetization.apis.products);return this.getBillingRegionCache().then(function(i){return t.generateDataManagerRequestOptions(e,n).then(function(n){var o=t.utilityService.combineUriComponents(e.endpointUri,e.productsPath);i&&(o=t.utilityService.appendQueryStringToUrl(o,e.billingRegionQueryString,i.country));var s={url:""+o,method:"GET",timeout:e.productsHttpTimeoutSeconds*t.constants.timeInMiliseconds.second,skipCommonHeaders:!0};return t.productListDataManager.invoke(s,n)}).then(function(e){if(!e)throw"empty response from Products";return n.stop(),t.putMonetizationAppsListCache(e),e}).catch(function(e){var t=JSON.stringify(teamspace.services.AppsServiceUtils.getSafeError(e));return n.fail({error:t,error2:t}),Promise.resolve(null)})})},t.prototype.getAssetsFromAPI=function(e){var t=this,n=this.loggingService.newScenario(this.constants.scenarios.extensibility.monetization.apis.products);return this.getBillingRegionCache().then(function(i){return t.generateDataManagerRequestOptions(e,n).then(function(n){var o=t.utilityService.combineUriComponents(e.endpointUri,e.assetsPath);i&&(o=t.utilityService.appendQueryStringToUrl(o,e.billingRegionQueryString,i.country));var s={url:""+o,method:"GET",timeout:e.assetsHttpTimeoutSeconds*t.constants.timeInMiliseconds.second,skipCommonHeaders:!0};return t.assetListDataManager.invoke(s,n)}).then(function(e){if(!e)throw"empty response from Assets";return n.stop(),t.putAssetsListCache(e),e}).catch(function(e){var t=JSON.stringify(teamspace.services.AppsServiceUtils.getSafeError(e));return n.fail({error:t,error2:t}),Promise.resolve(null)})})},t.prototype.generateDataManagerRequestOptions=function(e,t){var n=e.resourceUri;return this.authenticationService.getAuthToken(n).then(function(e){var n=new teamspace.services.DataManagerRequestOptions;return n.skipApply=!0,n.scenario=t,n.additionalHeaders={Authorization:"Bearer "+e.token},n})},t.prototype.open=function(){return this.isOpen?SkypeX.Services.SyncTasks.Resolved():this.monetizationDatabase.open()},Object.defineProperty(t.prototype,"isOpen",{get:function(){return this.monetizationDatabase.isOpen},enumerable:!0,configurable:!0}),t.prototype.getHashCode=function(e){if(e)return this.utilityService.djb2_hash(JSON.stringify(e))},t.prototype.validateCacheDataIntegrity=function(e,t){return!(!e||!t)&&t===this.getHashCode(e)},t.prototype.isCacheExpired=function(e,t){return!e||Math.abs((new Date).getTime()-e.getTime())>t*this.constants.timeInMiliseconds.second},t.prototype.getSupportedBillingRegionsCache=function(e){var t=this,n=this.loggingService.newScenario(this.constants.scenarios.extensibility.monetization.cache.getSupportedBillingRegionsIndexedDB);return this.open().then(function(){return n.appendEventData({event:t.constants.scenarios.extensibility.monetization.cache.openConnection}),t.monetizationDatabase.provider.openTransaction(t.monetizationDatabase.schema.stores.supported_billing_regions.name,!1,"monetizationClientCache:getCachedSupportedBillingRegions")}).then(function(e){return n.appendEventData({event:t.constants.scenarios.extensibility.monetization.cache.openTransaction}),e.store.openPrimaryKey().getAll()}).then(function(i){if(i&&i.length>0){var s=i[0];return s?s&&t.validateCacheDataIntegrity(s.countries,s.hash)?t.isCacheExpired(s.insertedDate,e.maxProductsAssetsAgeSeconds)?null:(n.stop(o({},t.getSupportedBillingRegionsEventData(s.countries))),s.countries):(n.fail({error:"Hash check mismatch",error2:"Hash check mismatch"}),null):(n.stop({message:"No Supported Billing Regions found in IndexedDB."}),null)}}).toNgPromise(this.$q).catch(function(e){var i=JSON.stringify(e);return t.logger.error("Failed to get monetization apps list from IndexedDb. Error: {0}",i),n.fail({error:i,error2:i}),null})},t.prototype.putSupportedBillingRegionsCache=function(e){var t=this,n=new Date,i={hash:this.getHashCode(e),insertedDate:n,countries:e},o=this.loggingService.newScenario(this.constants.scenarios.extensibility.monetization.cache.setSupportedBillingRegionsIndexedDB);return this.open().then(function(){return t.clearSupportedBillingRegionsCache(o)}).then(function(){return o.appendEventData({event:t.constants.scenarios.extensibility.monetization.cache.clearSupportedBillingRegions,step:"putSupportedBillingRegionsCache"}),t.monetizationDatabase.provider.openTransaction(t.monetizationDatabase.schema.stores.supported_billing_regions.name,!0,"monetizationClientCache:setCachedSupportedBillingRegions")}).then(function(e){return o.appendEventData({event:t.constants.scenarios.extensibility.monetization.cache.openTransaction,step:"putSupportedBillingRegionsCache"}),e.store.put(i)}).then(function(){o.stop({message:"Saved new Supported Billing Regions API response to IndexedDB"})}).catch(function(e){var n=JSON.stringify(e);return t.logger.error("Failed to set Supported Billing Regions list to IndexedDB. Error: "+n),o.fail({error:n,error2:n}),SkypeX.Services.SyncTasks.Rejected(n)})},t.prototype.clearSupportedBillingRegionsCache=function(e){var t=this;return this.open().then(function(){return e.appendEventData({event:t.constants.scenarios.extensibility.monetization.cache.openConnection,step:"clearSupportedBillingRegionsCache"}),t.monetizationDatabase.provider.openTransaction(t.monetizationDatabase.schema.stores.supported_billing_regions.name,!0,"monetizationClientCache:clearCachedSupportedBillingRegions")}).then(function(n){return e.appendEventData({event:t.constants.scenarios.extensibility.monetization.cache.openTransaction,step:"clearSupportedBillingRegionsCache"}),SkypeX.Services.SyncTasks.whenAll([n.store.clearAllData()])}).catch(function(n){var i=JSON.stringify(n);return t.logger.error("Failed to clear cached Supported Billing Regions list from IndexedDB. Error: {0}",i),e.fail({error:i,error2:i}),SkypeX.Services.SyncTasks.Rejected(n)})},t.prototype.getBillingRegionCache=function(){var e=this,t=this.loggingService.newScenario(this.constants.scenarios.extensibility.monetization.cache.getBillingRegionIndexedDB);return this.open().then(function(){return t.appendEventData({event:e.constants.scenarios.extensibility.monetization.cache.openConnection}),e.monetizationDatabase.provider.openTransaction(e.monetizationDatabase.schema.stores.billing_region.name,!1,"monetizationClientCache:getCachedBillingRegion")}).then(function(n){return t.appendEventData({event:e.constants.scenarios.extensibility.monetization.cache.openTransaction}),n.store.openPrimaryKey().getAll()}).then(function(n){if(n&&n.length>0){var i=n[0];return i?i&&e.validateCacheDataIntegrity(i.billingRegion,i.hash)?(t.stop(o({},e.getBillingRegionEventData(i.billingRegion))),i.billingRegion):(t.fail({error:"Hash check mismatch",error2:"Hash check mismatch"}),null):(t.stop({message:"No Billing Region found in IndexedDB."}),null)}}).toNgPromise(this.$q).catch(function(e){var n=JSON.stringify(e);return t.fail({error:n,error2:n}),null})},t.prototype.putBillingRegionCache=function(e){var t=this,n=this.loggingService.newScenario(this.constants.scenarios.extensibility.monetization.cache.setBillingRegionIndexedDB);if(e){var i=new Date,o={hash:this.getHashCode(e),insertedDate:i,billingRegion:e};return this.open().then(function(){return t.clearBillingRegionCache(n)}).then(function(){return n.appendEventData({event:t.constants.scenarios.extensibility.monetization.cache.clearBillingRegion,step:"putBillingRegionCache"}),t.monetizationDatabase.provider.openTransaction(t.monetizationDatabase.schema.stores.billing_region.name,!0,"monetizationClientCache:setCachedBillingRegion")}).then(function(e){return n.appendEventData({event:t.constants.scenarios.extensibility.monetization.cache.openTransaction,step:"putBillingRegionCache"}),e.store.put(o)}).then(function(){n.stop({message:"Saved Billing Region to IndexedDB"})}).catch(function(e){var i=JSON.stringify(e);return t.logger.error("Failed to set Billing Region to IndexedDB. Error: "+i),n.fail({error:i,error2:i}),SkypeX.Services.SyncTasks.Rejected(i)})}this.clearBillingRegionCache(n)},t.prototype.clearBillingRegionCache=function(e){var t=this;return this.open().then(function(){return e.appendEventData({event:t.constants.scenarios.extensibility.monetization.cache.openConnection,step:"clearBillingRegionsCache"}),t.monetizationDatabase.provider.openTransaction(t.monetizationDatabase.schema.stores.billing_region.name,!0,"monetizationClientCache:clearCachedBillingRegion")}).then(function(n){return e.appendEventData({event:t.constants.scenarios.extensibility.monetization.cache.openTransaction,step:"clearBillingRegionsCache"}),SkypeX.Services.SyncTasks.whenAll([n.store.clearAllData()])}).catch(function(n){var i=JSON.stringify(n);return t.logger.error("Failed to clear cached Billing Region from IndexedDB. Error: {0}",i),e.fail({error:i,error2:i}),SkypeX.Services.SyncTasks.Rejected(n)})},t.prototype.getAssetsListCache=function(e){var t=this,n=this.loggingService.newScenario(this.constants.scenarios.extensibility.monetization.cache.getAssetsListIndexedDB);return this.open().then(function(){return n.appendEventData({event:t.constants.scenarios.extensibility.monetization.cache.openConnection}),t.monetizationDatabase.provider.openTransaction(t.monetizationDatabase.schema.stores.monetization_assets_list.name,!1,"monetizationClientCache:getCachedAssets")}).then(function(e){return n.appendEventData({event:t.constants.scenarios.extensibility.monetization.cache.openTransaction}),e.store.openPrimaryKey().getAll()}).then(function(i){if(i&&i.length>0){var s=i[0];return s?s&&t.validateCacheDataIntegrity(s.assets,s.hash)?t.isCacheExpired(s.insertedDate,e.maxProductsAssetsAgeSeconds)?null:(n.stop(o({},t.getAssetsListEventData(s.assets))),s.assets):(n.fail({error:"Hash check mismatch",error2:"Hash check mismatch"}),null):(n.stop({message:"No assets list found in IndexedDB."}),null)}}).toNgPromise(this.$q).catch(function(e){var i=JSON.stringify(e);return t.logger.error("Failed to get assets list from IndexedDb. Error: {0}",i),n.fail({error:i,error2:i}),null})},t.prototype.putAssetsListCache=function(e){var t=this,n=new Date,i={hash:this.getHashCode(e),insertedDate:n,assets:e},o=this.loggingService.newScenario(this.constants.scenarios.extensibility.monetization.cache.setAssetsListIndexedDB);return this.open().then(function(){return t.clearAssetsListCache(o)}).then(function(){return o.appendEventData({event:t.constants.scenarios.extensibility.monetization.cache.clearAssetsList,step:"putAssetsListCache"}),t.monetizationDatabase.provider.openTransaction(t.monetizationDatabase.schema.stores.monetization_assets_list.name,!0,"monetizationClientCache:setCachedAssets")}).then(function(e){return o.appendEventData({event:t.constants.scenarios.extensibility.monetization.cache.openTransaction,step:"putAssetsListCache"}),e.store.put(i)}).then(function(){o.stop({message:"Saved new assets list API response to IndexedDB"})}).catch(function(e){var n=JSON.stringify(e);return t.logger.error("Failed to set assets list to IndexedDB. Error: "+n),o.fail({error:n,error2:n}),SkypeX.Services.SyncTasks.Rejected(n)})},t.prototype.clearAssetsListCache=function(e){var t=this;return this.open().then(function(){return e.appendEventData({event:t.constants.scenarios.extensibility.monetization.cache.openConnection,step:"clearAssetsListCache"}),t.monetizationDatabase.provider.openTransaction(t.monetizationDatabase.schema.stores.monetization_assets_list.name,!0,"monetizationClientCache:clearCachedAssets")}).then(function(n){return e.appendEventData({event:t.constants.scenarios.extensibility.monetization.cache.openTransaction,step:"clearAssetsListCache"}),SkypeX.Services.SyncTasks.whenAll([n.store.clearAllData()])}).catch(function(n){var i=JSON.stringify(n);return t.logger.error("Failed to clear cached assets list from IndexedDB. Error: {0}",i),e.fail({error:i,error2:i}),SkypeX.Services.SyncTasks.Rejected(n)})},t.prototype.getMonetizationAppsListCache=function(e){var t=this,n=this.loggingService.newScenario(this.constants.scenarios.extensibility.monetization.cache.getMonetizationAppsListIndexedDB);return this.open().then(function(){return n.appendEventData({event:t.constants.scenarios.extensibility.monetization.cache.openConnection}),t.monetizationDatabase.provider.openTransaction(t.monetizationDatabase.schema.stores.monetization_apps_list.name,!1,"monetizationClientCache:getCachedMonetizationApps")}).then(function(e){return n.appendEventData({event:t.constants.scenarios.extensibility.monetization.cache.openTransaction}),e.store.openPrimaryKey().getAll()}).then(function(i){if(i&&i.length>0){var s=i[0];return s?s&&t.validateCacheDataIntegrity(s.products,s.hash)?t.isCacheExpired(s.insertedDate,e.maxProductsAssetsAgeSeconds)?null:(n.stop(o({},t.getMonetizationAppsListEventData(s.products))),s.products):(n.fail({error:"Hash check mismatch",error2:"Hash check mismatch"}),null):(n.stop({message:"No monetization apps list found in IndexedDB."}),null)}}).toNgPromise(this.$q).catch(function(e){var i=JSON.stringify(e);return t.logger.error("Failed to get monetization apps list from IndexedDb. Error: {0}",i),n.fail({error:i,error2:i}),null})},t.prototype.putMonetizationAppsListCache=function(e){var t=this,n=new Date,i={hash:this.getHashCode(e),insertedDate:n,products:e},o=this.loggingService.newScenario(this.constants.scenarios.extensibility.monetization.cache.setMonetizationAppsListIndexedDB);return this.open().then(function(){return t.clearMonetizationAppsListCache(o)}).then(function(){return o.appendEventData({event:t.constants.scenarios.extensibility.monetization.cache.clearMonetizationAppsList,step:"putMonetizationAppsListCache"}),t.monetizationDatabase.provider.openTransaction(t.monetizationDatabase.schema.stores.monetization_apps_list.name,!0,"monetizationClientCache:setCachedMonetizationApps")}).then(function(e){return o.appendEventData({event:t.constants.scenarios.extensibility.monetization.cache.openTransaction,step:"putMonetizationAppsListCache"}),e.store.put(i)}).then(function(){o.stop({message:"Saved new monetization apps list API response to IndexedDB"})}).catch(function(e){var n=JSON.stringify(e);return t.logger.error("Failed to set monetization apps list to IndexedDB. Error: "+n),o.fail({error:n,error2:n}),SkypeX.Services.SyncTasks.Rejected(n)})},t.prototype.clearMonetizationAppsListCache=function(e){var t=this;return this.open().then(function(){return e.appendEventData({event:t.constants.scenarios.extensibility.monetization.cache.openConnection,step:"clearMonetizationAppsListCache"}),t.monetizationDatabase.provider.openTransaction(t.monetizationDatabase.schema.stores.monetization_apps_list.name,!0,"monetizationClientCache:clearCachedMonetizationApps")}).then(function(n){return e.appendEventData({event:t.constants.scenarios.extensibility.monetization.cache.openTransaction,step:"clearMonetizationAppsListCache"}),SkypeX.Services.SyncTasks.whenAll([n.store.clearAllData()])}).catch(function(n){var i=JSON.stringify(n);return t.logger.error("Failed to clear cached monetization apps list from IndexedDB. Error: {0}",i),e.fail({error:i,error2:i}),SkypeX.Services.SyncTasks.Rejected(n)})},t.prototype.getMonetizationAppsListEventData=function(e){var t=this;if(e){var n=[];return e.forEach(function(e){n.push(t.getMonetizationPlansEventData(e))}),n}},t.prototype.getMonetizationPlansEventData=function(e){if(e)return{productId:e.officeProductId,name:e.officeProductName}},t.prototype.getAssetsListEventData=function(e){var t=this;if(e){var n=[];return e.forEach(function(e){n.push(t.getAssetEventData(e))}),n}},t.prototype.getAssetEventData=function(e){if(e)return{productId:e.saasBigCatalogId,purchaseStartDate:e.purchaseStartDate,licenseCount:e.licenseCount?e.licenseCount:0,isActive:!!e.isActive&&e.isActive}},t.prototype.getSupportedBillingRegionsEventData=function(e){var t=this;if(e){var n=[];return e.forEach(function(e){n.push(t.getSupportedBillingRegionEventData(e))}),n}},t.prototype.getSupportedBillingRegionEventData=function(e){if(e)return{countryCode:e.countryCode,countryName:e.countryName}},t.prototype.getBillingRegionEventData=function(e){if(e)return{country:e.country,countryName:e.countryName,language:e.language,culture:e.culture}},t}(teamspace.services.MTMABase);t.MonetizationService=a,angular.module("teamspace.monetizationService",["skypeX.myUserPreferencesStore","teamspace.appState","teamspace.authenticationService","teamspace.constants","teamspace.dataManagerService","teamspace.localizationService","teamspace.loggingService","teamspace.orchestrationService","teamspace.settingsService","teamspace.utilityService","skypeX.clientDatabase"]).service("monetizationService",a)}},[2505]);